<!DOCTYPE html>
<html>
<head>
<title>Remote</title>
<style>
    body {
        width: 35em;
        margin: 0 auto;
        font-family: Tahoma, Verdana, Arial, sans-serif;
    }
</style>
<script
  src="https://code.jquery.com/jquery-3.2.1.min.js"
  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
  crossorigin="anonymous"></script>
</head>
<body>
playlists
<select id="playlists">
</select>
<a onclick="analyze()">Analyze</a>

<a onclick="play()">Play</a>
<script>
/* UI
/
about + connect
/home
select device + rescan
hiitfy ui
	
*/
	var client_id = '9d4ecfc733cf415887763c509a274bc5';
	var token;
	var userId;
	if (!token &&!location.hash) {
		window.location.replace('https://accounts.spotify.com/authorize?client_id='+client_id+'&redirect_uri=http%3A%2F%2Flocalhost%3A8080&scope=user-read-private%20user-read-playback-state%20playlist-read-private%20playlist-read-collaborative%20user-modify-playback-state&response_type=token&state=123');
	} else {
		var o = new URLSearchParams(location.hash.substring(1));
		//TODO: check state matches
		token = o.get('access_token');
		console.log(token);
		$.ajax({
    		url: "https://api.spotify.com/v1/me/player/devices",
    		headers: {"Authorization": "Bearer "+token}
		}).done(function(data) {
  			console.log(data);
		});

		$.ajax({
    		url: "https://api.spotify.com/v1/me",
    		headers: {"Authorization": "Bearer "+token}
		}).done(function(data) {
			userId = data.id
  			console.log(userId);
		});		

		function startSong(id, startPos) {
			$.ajax({
	    		url: "https://api.spotify.com/v1/me/player/play",
	    		headers: {"Authorization": "Bearer "+token},
	    		type: 'PUT',
	    		data: JSON.stringify(
	            {
	            	"uris":["spotify:track:"+id]
	        	}             
	        	),
	        	contentType: "application/json"
			}).done(function(data) {
				$.ajax({
		    		url: "https://api.spotify.com/v1/me/player/seek?position_ms="+Math.round(startPos * 1000),
		    		type: 'PUT',
		    		contentType: "application/json",
		    		headers: {"Authorization": "Bearer "+token}
				}).done(function(data) {
		  			console.log("start playing "+id + " at " + startPos);
				});  			
			});
		}

		var playIntId;
		var currSong = 0;
		function play() {
			currSong = 0;
			console.log(playlistTracks, analysis);
			playIntId = setInterval(handlePlay, 10000);
		}

		function handlePlay() {
			console.log(playlistTracks[currSong], analysis[playlistTracks[currSong]]);
			if (currSong < playlistTracks.length) {
				startSong(playlistTracks[currSong], analysis[playlistTracks[currSong]]);
				currSong++;
			} else {
				clearInterval(playIntId);
			}
		}


		$('#playlists').empty()
		getPlayLists(0, 50);
		function getPlayLists(offset, limit) {
			$.ajax({
	    		url: "https://api.spotify.com/v1/users/spoteafy/playlists?limit="+limit+"&offset="+offset,
	    		headers: {"Authorization": "Bearer "+token}
			}).done(function(data) {
	  			for (var i = 0; i < data.items.length; i++) {
	  				$('#playlists')
	  					.append($('<option>', { value : data.items[i].id })
          				.text(data.items[i].name)); 
	  			}
	  			if (data.next) {
	  				getPlayLists(data.offset + data.limit, data.limit);
	  			}
			});
		}

		var outgoing = 0;
		function analyze() {
			getPlaylistTracks(0,100,$('#playlists').val(),null, function(data, next) {
				var ids = "";
				outgoing += data.items.length;
				for (var i = 0; i < data.items.length; i++) {
					if (data.items[i].track.is_playable) {
						if (i > 0) ids += ",";
						ids += data.items[i].track.id;
						//console.log(data.items[i]);
						playlistTracks.push(data.items[i].track.id);
					} else {
						console.log('track not available', data.items[i].track);
					}
				}
				getAudioFeatures(ids);
				if (!next) {
					console.log('playlist tracks done ' + outgoing);
				}
			});
		}

		var playlistTracks = [];
		var analysis = [];

		function getPlaylistTracks(offset,limit,playlist,href, cb) {
			$.ajax({
	    		url: href!=null?href:"https://api.spotify.com/v1/users/spoteafy/playlists/"+playlist+"/tracks?fields=items(track(name,id,is_local,is_playable)),next,offset,limit&limit="+limit+"&offset="+offset+"&market=SE",
	    		headers: {"Authorization": "Bearer "+token}
			}).done(function(data) {
				if (data && data.next) {
	  				getPlaylistTracks(data.offset + data.limit, data.limit,null,data.next,cb);
	  			} 
	  			cb(data, data.next);
			});
		}

		function handleErrors(response) {
		    if (!response.ok) {
		        throw Error(response.statusText);
		    }
		    return response;
		}

		function getAudioFeatures(ids) {
			// max 100 ids
			$.ajax({
	    		url: "https://api.spotify.com/v1/audio-features/?ids="+ids,
	    		headers: {"Authorization": "Bearer "+token}
			}).done(function(data) {
				//console.log(data);
				for (var i = 0; i < data.audio_features.length; i++) {
					//console.log(data.audio_features[i].id + " "+ data.audio_features[i].loudness);
					var lsid = localStorage.getItem(data.audio_features[i].id);
					if (!lsid) {
						var req = new Request(data.audio_features[i].analysis_url,{
							headers: new Headers({
								"Authorization": "Bearer "+token
							})
						});
						fetch(req)
						.then(handleErrors)
						.then(function(response) {
							Promise.all([Promise.resolve(response.url), response.json()]).then(function(o){
								var url = o[0];
								var data = o[1];
								var loudness = data.track.loudness;
								var eofi = data.track.end_of_fade_in;
								var startAt = 0;
								for (var i = 0; i < data.sections.length;i++) {
									if (data.sections[i].duration >= 20 && data.sections[i].loudness > loudness) {
										startAt = data.sections[i].start;
										break;
									}
								}
								startAt = Math.max(startAt, eofi);
								var str = "/audio-analysis/"
								var id = url.substring(url.lastIndexOf(str)+ str.length);
								console.log(url, id, startAt);
								localStorage.setItem(id, startAt);
								analysis[id] = startAt;
							});
						}).catch(function(error) {
							console.log(error);
						});
					} else {
						analysis[data.audio_features[i].id] = lsid;
						console.log("already got " + data.audio_features[i].id + " in cache");
					}
				}	
			});
		}
	}

</script>

</body>
</html>
